---
labels: [ソフトウェア開発, Docker, 社内勉強会]
---

# Docker Composeによるローカル開発環境構築（執筆中）

ローカル開発環境の重要性と、ローカル開発環境構築のベストプラクティスのひとつであるDocker/Docker Composeについて述べる。

## ローカル開発環境

アプリケーションの開発現場では、大まかに以下のような環境が構築される。

- 本番環境
- ステージング環境
- 検証/QA環境

実際の開発の際には上記の他に、ローカル開発環境の構築が望ましい。特に効率の良い開発のために洗練されたローカル開発環境が求められる。

## イテレーション

ソフトウェア開発で重要なのは素早いイテレーションである。ここでのイテレーションとは以下の作業を繰り返すことである。

1. ソースコードの編集
2. ソフトウェアのビルド
3. 動作確認・テストの実行
4. バグ・不具合の特定

素早いイテレーションを実現できれば、ソースコードの編集についての結果や問題がただちに分かり、次の開発作業の方向性を素早く決定していける。
よって素早くイテレーションを回すことは、開発者の生産性向上につながるといえる。

## ローカル開発環境

上記の高速なイテレーション実現のために必要なのがローカル開発環境である。ローカル開発環境とは以下のような特徴を持つ環境である。

- ローカルマシン上でビルド・実行・テストされる
- ネットワークが遮断されていてもある程度動作する
- 開発者毎に個別に構築される

ソースコードの編集からビルド・実行・テストを手元のマシンに完結することが特徴である。つまりイテレーションの1~4をローカルマシンに完結して実施できる。
ネットワークを超えたソースコードの転送・反映など時間のかかる作業がイテレーションに入り込まない。そのため他のどの環境よりも素早いイテレーションを実現可能な環境といえる。

## ローカル開発環境構築時の問題

イテレーション高速化のためには、ローカル開発環境の必要であると分かる。しかし、問題はローカル開発環境の構築時にある。洗練されたローカル開発環境構築は意外と難しい。それは以下のようなローカル開発環境特有の問題があるからである。

- 開発者によって、マシンの機種が異なる
- 開発者によって、マシン・OS・シェルなどの設定が異なる
- 開発者によって、インストール済みの開発ツール・言語・ライブラリのバージョンが異なる
- 上記各種の差異があるため、環境構築自動化が難しい

すなわち、ローカル開発環境構築の問題は、開発者毎に構築される環境間の差異に収束する。

## Docker/Docker Composeによる開発環境の抽象化

昨今では上記のようなローカル開発環境構築の課題解消のために、Docker及び、Docker Composeの利用が一般的となってきた。

ソフトウェアの世界では一般的だが、差異を吸収するための武器は抽象化である。Dockerはアプリケーション実行環境を抽象化するコンテナ技術を基礎としたツールであり、開発環境の抽象化にも極めて相性の良いツールである。

Docker/Docker Composeによるローカル開発環境の定義及び構築方法を示していく。

## Dockerfile

まずは開発対象のアプリケーションを動作させるためのDockerコンテナを定義する。プロジェクトルートにDockerfileを配置し、記述していく。ここでは一般的なDockerfileの記述方法は割愛し、ローカル開発環境定義に特有なDockerfile記述法を示す。

### WORKDIR

ローカル開発環境のためのDockerfileには `WORKDIR` を指定すると便利である。このWORKDIRには後述するように、ソフトウェアプロジェクトのルートをボリュームマウントする。

```
// Dockerfile

WORKDIR /app
```

尚、WORKDIRの指定場所に決まりはないが、`/` 付近としておくとタイプがしやすく地味によい。

### CMD

メインアプリケーション実行のためのコマンドを `CMD` で指定する。開発しているアプリケーションの実行コマンドが自明でないことも多い、`CMD` に指定しておくことで他の開発者にも決まった実行方法でアプリケーションを実行してもらえる。

```
// Goアプリケーションの例
CMD ["go", "run", "./cmd/app"]

// Java/Spring Bootアプリケーションの例
CMD ["./mvnw", "spring-boot:run"]
```

注意点として、`CMD` にはビルド自体を内包したコマンドを指定するのがおすすめである。例えば以下のように、ビルドを `CMD` の前に指定するのは避けたい。

```
// CMDの前にビルドして、CMDではビルドしない
RUN go build ./cmd/app
CMD ["./app"]
```

上記の指定の場合、コンテナを再起動しただけでは、最新のコードが反映されず、Dockerイメージの再ビルドが必要になってしまう。ビルド自体を `CMD` に含めることで、コンテナを再起動しただけで最新コードを反映できる。また、確実に再起動のみで確実に最新コードを反映できるため、反映前に誤って動作確認・テストしてしまうミスの防止効果もある。

尚、`CMD` の他に `ENTRYPOINT` による実行コマンド指定も可能である。しかしローカル開発環境には `CMD` が適する。`ENTRYPOINT` は、コンテナの実行コマンドが固定化するため、開発中のデバッグ作業などで別の実行コマンドを試したい場合に対応し辛い。

## docker-compose.yml

1つのDockerfileは1コンテナの内容のみを定義するものである。またDockerでは1コンテナ内では原則1プロセスのみの稼働が推奨されている。よってDockerのみでは例えばDBと接続するアプリケーションなど、複数のプロセスから成るアプリケーションの開発には不十分である。

そこで、Docker Composeを用いる。Docker Composeは、 

(執筆中)

## Docker/Docker Composeで構築した際のよくある作業

(執筆中)
